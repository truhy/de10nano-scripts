# GNU makefile script to build U-Boot for OpenOCD board initialisation

Truong Hy.  22/04/2024

Contains scripts for building U-Boot (actually U-Boot-SPL) for use with OpenOCD to configure the Terasic DE-10 Nano development board.  Before bare-metal programs can run off the SDRAM, we need to initialise the 1GB DDR3 SDRAM, setup clocks and PLLs following the settings described by handoff files (folder hps_isw_handoff).  The included handoff files are from my HPS UART controller HDL project, which were generated by Platform Designer (Qsys), so you may want to replace them with yours.

U-Boot-SPL can be loaded to On-Chip RAM (of the processor) directly from OpenOCD, using the load_image and resume command.  The SPL will run and initialise the DE-10 Nano for you.  Then we can load and run a user bare-metal program from SDRAM and debug it.

## Script notes

The scripts are not perfect, I am mostly a Windows user.  Tested on Ubuntu 22.04.2 LTS within Oracle Virtual Box, and with newer GNU Arm toolchain and U-Boot versions.

All script settings are placed inside the "scripts-env" folder, so edit the files if you want to use different toolchain or U-Boot versions.

## Quick steps

1. In your home directory, create a folder named devtools for storing the GNU toolchain for Arm and U-Boot source zip files

2. Download xPack's GNU toolchain for Arm:
  https://github.com/xpack-dev-tools/arm-none-eabi-gcc-xpack/releases

  Hints:
    You may need to click on Assets, and Show all x files.
    The version I used is v12.2.1-1.2:
      https://github.com/xpack-dev-tools/arm-none-eabi-gcc-xpack/releases/tag/v13.2.1-1.1/
      File: xpack-arm-none-eabi-gcc-13.2.1-1.1-win32-x64.zip
			
	Alternatively, download Arm's GNU toolchain for Arm:
	https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads

2. Decompress it to ~/devtools folder

3. Download U-Boot source code from:
  https://github.com/u-boot/u-boot/tags

  Hints:
    The source code version I used is v2024.04:
      https://github.com/u-boot/u-boot/tree/v2024.04
      File: u-boot-2024.04.zip
      
Alternatively, download Intel/Altera's fork:
  https://github.com/altera-opensource/u-boot-socfpga

4. Move the U-Boot source code zip to ~/devtools folder, or if you're using WSL then start File Explorer, you should see the WSL Linux/Ubuntu mounted drive, copy zip to home/yourusername/devtools

5. Start a terminal and change working directory to the folder with Makefile and type in make debug
This will unzip it into a new folder called software and also applies my patches

If everything is ok you should find the compiled U-Boot-SPL elf file:
Debug/u-boot-spl

## Running with OpenOCD

Sorry, I have no time to write a detail guide on using OpenOCD in this document, instead will show some quick notes.
First make sure you put U-Boot-SPL in your terminal working directory.  OpenOCD will search current directory for file.
Run OpenOCD and connect to it.  If you want to use GDB then you know the usual, type monitor infront of each command.

## Here are some useful commands

==============================================

To warm reset the DE-10 Nano processor system (HPS) from a terminal connected to OpenOCD:
```
halt
mww 0xffd05004 0x00100002
```

Alternatively, you can just press the HPS warm reset button (KEY3) on the board - the one right next to the slider switches.

==============================================

To run U-Boot-SPL from a terminal connected to OpenOCD:
```
halt
load_image u-boot-spl
resume 0xffff0000
```

==============================================

To run U-Boot-SPL and a user application from a terminal connected to OpenOCD:
```
halt
load_image u-boot-spl
resume 0xffff0000
sleep 200
halt
arm core_state arm
load_image your_app.elf
resume your_app_entry_point_address
```

==============================================

To get entry point of your elf, run readelf commandline tool from your toolchain, e.g. from a command prompt or command/shell terminal:
```
arm-none-eabi-readelf -h your_app.elf
```
